---
title: 쓰레드
tags: ['thread','semaphore']
categories: [☁️ OS]
thumbnail: ''
permalink: ''
status: 'ing'
date: 2021-05-11 23:32:46
---

Thread 의 개념, 동기화 이슈 그리고 세마포어
`#semaphore` `#thread` `#mutex` `#임계영역`
<!-- excerpt -->
<!-- toc -->

# Thread 쓰레드?
- 한마디로 프로세스의 서브셋이다.
- `Light Weight Process` 라고도 한다.
- 하나의 프로세스에 여러개 스레드 생성이 가능하다.
- 스레드를 동시에 실행 가능하다.
- 프로세스 내부에 있으므로 `프로세스 데이터에 접근이 가능`하다.
- 각 스레드마다 `stack`이 존재한다.

## Process vs Thread
- Process
 - 프로세스 간 서로의 영역에 데이터 접근이 불가하다.
 - 자신만의 주소를 갖는다. (독립적)
 - 통신을 위해서 IPC 기법이 필요하다.
- Thread
 - 프로세스 자원 정보가 공유된다.
 - 스레드 간의 주소 영역을 공유한다.
  - CODE, DATA, HEAP 영역을 공유.

## Multi Thread
- 최근의 CPU 는 멀티 프로세싱이 가능하므로 (여러개 CPU) 프로세스 내에도 여러개의 스레드를 만들어 멀티코어의 활용도를 높인다.

## Thread 의 장.단점
- 장점
 - 사용자에 대한 응답속도 향상 (T1이 특정작업을 하는 동시에 T2는 사용자와 통신을 한다.)
 - 프로세스의 자원공유를 위해서 사용되는 IPC (Inter Processing Communication) 기법과 같이, 별도의 작업을 할 필요가 없다.
 - 프로세스의 데이터에 접근 할 수 있다.
- 단점
 - 하나의 프로세스에 있는 여러개 스레드 중 하나라도 문제가 생기면, 전체 프로세스에 영향을 미친다.
 - 스레드를 너무 많이 생성하면 Context Switching 이 빈번하게 발생하여 성능이 저하될 수 있다. (모든 스레드를 스케줄링 해야하므로.)

> * PThread = POSIX Threads
>  - Thread 관련 표준 API

# 동기화 (Synchronization) 이슈
- 동시에 여러개의 스레드가 동잃한 자원을 사용할 경우 발생한다.
- 동일 자원을 여러 스레드가 동시 수정시 최종 결과에 영향을 미친다.

## 동기화 이슈 해결방안
- 상호배제 (Mutual Extension)
 - 여러 스레드가 사용중인(변경중인) 공유 변수에 대해 배제 (exclusive access) 필요하다.
 - 하나의 스레드가 어떤 자원을 사용할 때 다른 스레드가 동시에 접근할 수 없도록 막는다.

# 임계영역
- 하나의 스레드의 접근만 허락된 영역. 둘 이상의 스레드가 접근하면 문제를 일으킬 수 코드들.

## Mutex 와 Semaphore
- Mutex(binary semaphore) : 임계영역에 하나의 스레드만 접근 가능하다.
- Semaphore : 카운터를 두어, 임계영역역에 허용 가능한 스레드 개수만큼 여러개의 스레드가 동시에 접근할 수 있도록 한다.

### Semaphore 수도코드
- 세마포어를 아래 조건에서 수도코드로 나타냈을때.
 - P: 검사 (임계영역에 `들어갈때`) S값이 1이상이면 임계영역 진입후 S 값 차감. (S값이 0이면 대기)
 - V: 증가 (임계영역에서 `나올때`) S 값에 1을 더하고 임계 영역을 나옴.
 - S: 세마포어 값 (초기 값만큼 여러 프로세스가 동시에 임계 영역 접근가능)

```c++
P(S): wait(S){
  while S <= 0 ; // 바쁜 대기
  
  S--;
  // 다른 프로세스 접근 제한
}
```

```c++
V(S): signal(S){
  S++;
  // 다른 프로세스 접근 허용
}
```
- wait 바쁜 대기 (S<=0) 일 경우, 무한 loop -> 부하가 걸릴 수 있다.
@@@여기부터 작성


## 교착상태 (deadlock)
- 무한대기상태 : 두개 이상의 작업이 서로의 작업이 끝나기만을 기다리며, 다음 단계로 진행하지 못함.
- 프로세스, 쓰레드에서 모두 일어날 수 있다.
- 배치 프로그램에서는 일어나지 않는다.
- 교착상태 발생조건
 - 상호배제(Mutual Exclusion) : 프로세스들이 필요로하는 공유자원에 대해 권한 접근이 제한되기 때문에 한번에 하나의 프로세스만 공유자원을 사용할 수 있다.
 - 점유대기 : 이미 자원을 할당받은 프로세스가 그 자원을 양보하지 않은 상태에서 다른 자원을 요구할 수 있다.
 - 비선점 : 프로세스가 어떤 자원의 사용을 끝날때까지 뺏을 수 없다. 즉, 한 프로세스가 다른 프로세스의 접근 권한을 강제로 취소할 수 없다.
 - 순환대기 : 각 프로세스는 순환적으로 다음 프로세스가 요구하는 자원을 가지고 있다. 두 개 이상의 프로세스가 자원 할당을 기다리는 사이클이 존재한다.

## 기아상태 (Starvation)
- 우선순위가 낮은 프로세스가 원하는 자원을 영원히 할당받지 못하는 상태.
- 해결방안
 - 프로세스 우선순위를 수시로 변경해서 할당받을 기회를 준다.
 - 오리 기다린 프로세스의 우선순위를 높여준다.
 - 우선순위가 아니라, 요청을 순서대로 처리하는 FIFO 기반 큐를 사용한다.