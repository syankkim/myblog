---
title: ìŠ¤í”„ë§ ì‹œíë¦¬í‹° OAuth ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥êµ¬í˜„
tags: ['spring','OAuth2']
categories: [â˜ï¸ Spring]
thumbnail: ''
permalink: ''
date: 2020-03-26 22:17:40
---

ğŸƒ SpringBoot, SpringSecurity, OAuth2 ë¥¼ ì´ìš©í•´ Google ë¡œê·¸ì¸ì„ êµ¬í˜„í•´ ë´…ë‹ˆë‹¤.
<!-- excerpt -->
<!-- toc -->

---
<br/>

### ìŠ¤í”„ë§ ì‹œíë¦¬í‹° Spring Security
> ì¸ì¦(Authentication)ê³¼ ì¸ê°€(Authorization) (ê¶Œí•œë¶€ì—¬)ë¥¼ ê°€ì§„ í”„ë ˆì„ì›Œí¬ì´ë‹¤.
- 2.0 ë²„ì „ì—ì„œ ë¶€í„°ëŠ” client ì¸ì¦ì •ë³´ë§Œ í•„ìš”ë¡œ í•˜ê²Œ ë˜ì—ˆë‹¤.

### Google Cloud Platform ì—ì„œ ì¸ì¦ìš© API ì‹ ì²­í•˜ê¸°

> [êµ¬ê¸€í´ë¼ìš°ë“œ í”Œë«í¼](https://console.cloud.google.com/home/dashboard?project=fruite) ì— ì ‘ì†í•˜ì—¬ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•œë‹¤. ì—¬ê¸°ì„œ ë°œê¸‰ëœ ì¸ì¦ì •ë³´ `clientId`, `clientSecret` ì„ í†µí•´ ìŠ¤í”„ë§ ì‹œíë¦¬í‹°ë¥¼ ì‚¬ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.


__ìƒì„±ëœ í”„ë¡œì íŠ¸ì—ì„œ OAuth ë™ì˜í™”ë©´ì„ êµ¬ì„±í•œë‹¤.__
![image](https://user-images.githubusercontent.com/28856435/77653327-e1b7c380-6fb2-11ea-98bd-5ac9eb7393db.png)
<br/>

__ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ ìœ í˜•ì˜ ì‚¬ìš©ì ì¸ì¦ì •ë³´ë¥¼ ë§Œë“ ë‹¤.__
![image](https://user-images.githubusercontent.com/28856435/77651410-17a77880-6fb0-11ea-9bf4-5ee0d1c1fed2.png)
<br/>

__ì•„ë˜ì™€ ê°™ì´ ì›¹ ì–´í”Œë¦¬ì¼€ì´ì…˜ì˜ í´ë¼ì´ì–¸íŠ¸IDê°€ ìƒì„±ë˜ì—ˆë‹¤.__
![image](https://user-images.githubusercontent.com/28856435/77651295-ecbd2480-6faf-11ea-85b2-09bbb8da3f9d.png)
<br/>


### ë¡œê·¸ì¸ êµ¬í˜„ì„ ìœ„í•œ ì„¤ì •

__build.gradle__
```java
implementation 'org.springframework.cloud:spring-cloud-starter-security:2.1.2.RELEASE'
implementation 'org.springframework.cloud:spring-cloud-starter-oauth2:2.1.2.RELEASE'

compile('org.springframework.security:spring-security-oauth2-client')
compile('org.springframework.security:spring-security-oauth2-jose')
 ```

 __application-oauth.properties__
 /src/main/resources/static/application-oauth.properties íŒŒì¼ì„ ì¶”ê°€í•œë‹¤.

```java
spring.security.oauth2.client.registration.google.client-id={í´ë¼ì´ì–¸íŠ¸ ID}
spring.security.oauth2.client.registration.google.client-secret={secret ì½”ë“œ}
spring.security.oauth2.client.registration.google.scope=profile,email
```

__.gitIgnore__
í•´ë‹¹ ì„¤ì •íŒŒì¼ì„ gitIgnore ì— ë„£ì–´ì¤€ë‹¤.
```java
application-oauth.properties
```

__application.yml__
`include: oauth` ë¥¼ ì¶”ê°€í•œë‹¤.

```yml
spring:
  profiles: 
    active: local
    include: oauth
```

### ì†Œì…œ ì¸ì¦ êµ¬í˜„í•˜ê¸°


#### ClientResources í´ë˜ìŠ¤
í”„ë¡œí¼í‹° ì„¤ì •ì„ í¸ë¦¬í•˜ê²Œ ì´ìš© í•  ìˆ˜ ìˆë‹¤.

```java
public class ClientResources {
	
	@NestedConfigurationProperty
	private AuthorizationCodeResourceDetails client = new AuthorizationCodeResourceDetails();
	@NestedConfigurationProperty
	private ResourceServerProperties resource = new ResourceServerProperties();
	
	public AuthorizationCodeResourceDetails geClient() {
		return client;
	}

	public ResourceServerProperties getResource() {
		return resource;
	}
}
```

** í˜¹ì‹œë‚˜ AuthorizationCodeResourceDetails ì´ ì¶”ê°€ë˜ì§€ ì•Šìœ¼ë©´ oauth2-autoconfigure ë””íœë˜ì‹œê°€ í•„ìš”í•˜ë‹¤.
   build.gradle ì— ì•„ë˜ì™€ ê°™ì´ ì¶”ê°€í•´ì¤€ë‹¤.
```java
compile 'org.springframework.security.oauth.boot:spring-security-oauth2-autoconfigure:2.1.7.RELEASE'
```

#### SecurityConfig í´ë˜ìŠ¤ ì‘ì„±

```java
@EnableWebSecurity
@EnableOAuth2Client
public class SecurityConfig extends WebSecurityConfigAdapter(){

  @Bean
  @ConfigurationProperties("google")
  public ClientResources google(){
    return new ClientResources();
  }
}

```

```java
// ì¸ì¦ ìš”ì²­ì— ë”°ë¥¸ ë¦¬ë‹¤ì´ë ‰ì…˜ì„ ìœ„í•œ ë¹ˆ ë“±ë¡
@Bean
public FilterRegistrationBean oauth2ClientFilterRegistration(OAuth2ClientContextFilter filter) {
	FilterRegistrationBean registration = new FilterRegistrationBean();
	registration.setFilter(filter);
	registration.setOrder(-100); //Spring Security í•„í„°ë³´ë‹¤ ìš°ì„ ìˆœìœ„ë¥¼ ë‚®ê²Œ ë‘”ë‹¤.
	return registration;
}
```


```java
private Filter ssoFilter() {
	CompositeFilter filter = new CompositeFilter();
	List<Filter> filters = new ArrayList<Filter>();
	
	filters.add(ssoFilter(google(), "/login/google"));
	filter.setFilters(filters);
	return filter;
}

private Filter ssoFilter(ClientResources client, String path) {
	// OAuth2ClientAuthenticationProcessingFilter
	// -> OAuth2 ì¸ì¦ ì„œë²„ì—ì„œ OAuth2 ì•¡ì„¸ìŠ¤ í† í°ì„ íšë“.
	// -> ì¸ì¦ ê°ì²´ë¥¼ SecurityContext ì— ë¡œë“œí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” OAuth2 í´ë¼ì´ì–¸íŠ¸ í•„í„°
	OAuth2ClientAuthenticationProcessingFilter filter = new OAuth2ClientAuthenticationProcessingFilter(path);
	OAuth2RestTemplate restTemplate = new OAuth2RestTemplate(client.getClient(), oauth2ClientContext);
	filter.setRestTemplate(restTemplate);
	UserInfoTokenServices tokenServices = 
			new UserInfoTokenServices(client.getResource().getUserInfoUri(), client.getClient().getClientId());
	filter.setTokenServices(tokenServices);
	return filter;
}
```
















